name: Deploy to Railway

on:
  push:
    branches: [main, dev]
  workflow_dispatch:

jobs:
  build-and-deploy:
    name: Build Theme & Deploy to Railway
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build production assets
        run: npm run build

      - name: Validate theme with GScan
        run: |
          npm install -g gscan
          gscan . --fatal --verbose

      - name: Create theme package
        run: |
          THEME_NAME="x-learn-ghost-theme"
          COMMIT_SHA="${GITHUB_SHA::7}"
          PACKAGE_NAME="${THEME_NAME}-${COMMIT_SHA}.zip"

          # Create zip excluding unnecessary files
          zip -r "$PACKAGE_NAME" . \
            -x "node_modules/*" \
            -x ".git/*" \
            -x "*.md" \
            -x "gulpfile.js" \
            -x "demo_content/*" \
            -x "scripts/*" \
            -x ".github/*" \
            -x ".gitignore" \
            -x "package-lock.json"

          echo "PACKAGE_NAME=$PACKAGE_NAME" >> $GITHUB_ENV
          echo "âœ… Created package: $PACKAGE_NAME ($(du -h $PACKAGE_NAME | cut -f1))"

      - name: Upload theme as artifact
        uses: actions/upload-artifact@v4
        with:
          name: ghost-theme
          path: ${{ env.PACKAGE_NAME }}
          retention-days: 30

      - name: Deploy to Railway (optional)
        if: github.ref == 'refs/heads/main'
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          # Only run if Railway token is configured
          if [ -z "$RAILWAY_TOKEN" ]; then
            echo "âš ï¸ RAILWAY_TOKEN not configured. Skipping auto-deploy."
            echo "ðŸ“¦ Download the artifact manually and upload to Ghost Admin."
            exit 0
          fi

          # Install Railway CLI
          npm install -g @railway/cli

          # Deploy (requires Railway project linked)
          echo "ðŸš€ Deploying to Railway..."
          # railway up --service ghost-theme || echo "âš ï¸ Railway deployment failed. Deploy manually."

      - name: Deployment summary
        run: |
          echo "## ðŸŽ‰ Build Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Package:** \`${{ env.PACKAGE_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¥ How to deploy:" >> $GITHUB_STEP_SUMMARY
          echo "1. Download the artifact from this workflow run" >> $GITHUB_STEP_SUMMARY
          echo "2. Go to your Ghost Admin: \`https://your-site.railway.app/ghost/\`" >> $GITHUB_STEP_SUMMARY
          echo "3. Navigate to **Settings â†’ Design â†’ Change theme**" >> $GITHUB_STEP_SUMMARY
          echo "4. Upload the \`.zip\` file and activate" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Quick Links:" >> $GITHUB_STEP_SUMMARY
          echo "- [Railway Dashboard](https://railway.app/dashboard)" >> $GITHUB_STEP_SUMMARY
          echo "- [Ghost Theme Docs](https://ghost.org/docs/themes/)" >> $GITHUB_STEP_SUMMARY
