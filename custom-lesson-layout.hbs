{{!< default}} {{#post}} {{!-- Get course using primary tag --}} {{#primary_tag}} {{#get "posts" limit="1"
   filter="primary_tag:{{slug}}+tag:hash-course" }} {{#foreach posts}} <div style="display:none" id="course-info-data"
   data-course-title="{{title}}" data-course-url="{{url}}">
   </div>
   {{/foreach}}
   {{/get}}
   {{/primary_tag}}

   {{!-- Breadcrumb Navigation --}}
   {{> breadcrumb}}

   {{!-- Hero Section - always show for lessons --}}
   {{> hero-section lesson_style="image_on_right"}}

   <section class="single-lesson-area pt-8 md:pt-10 lg:pt-16">
      <div class="container mx-auto">
         <div class="grid grid-cols-1 md:grid-cols-12 gap-4 md:gap-6 lg:gap-8">
            <div class="md:col-span-12 lg:col-span-4 lg:order-1 order-2">
               <div class="lesson-list-sidebar sticky top-8">
                  <div class="sidebar rounded-lg shadow duration-300">
                     <div class="left-lesson-list">
                        <!-- Lesson list container with loading state -->
                        <div class="lessons-container" data-load-lessons="true">
                           <h3
                              class="text-2xl font-bold text-gray-800 group-hover:text-blue-800 transition-colors duration-300 px-6 pt-6 pb-6">
                              {{t "course-lessons"}}
                           </h3>

                           {{#if access}}
                           <!-- Course Progress Section -->
                           <div class="course-progress px-6 pb-6 smooth-fade-in">
                              <div class="progress-stats flex justify-between items-center mb-2">
                                 <span class="text-sm text-gray-400">{{t "progress"}}</span>
                                 <span class="text-sm font-medium text-blue-800" id="progress-percentage">0%</span>
                              </div>
                              <div class="progress-bar bg-gray-200 rounded-full h-2 mb-2">
                                 <div class="progress-fill bg-blue-800 h-2 rounded-full transition-all duration-300"
                                    id="progress-fill" style="width: 0%"></div>
                              </div>
                              <div class="progress-text text-xs text-gray-400" id="progress-text">0 of 0 lessons
                                 completed</div>
                           </div>
                           {{/if}}

                           <!-- Loading indicator -->
                           <div class="lessons-loading px-6 py-4 text-center text-gray-500">
                              <svg class="animate-spin h-8 w-8 mx-auto mb-2" xmlns="http://www.w3.org/2000/svg"
                                 fill="none" viewBox="0 0 24 24">
                                 <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                    stroke-width="4"></circle>
                                 <path class="opacity-75" fill="currentColor"
                                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                 </path>
                              </svg>
                              <p>{{t "loading"}}...</p>
                           </div>

                           <!-- Lessons will be loaded here -->
                           <ol class="lesson-list" style="display:none;"></ol>
                        </div>
                     </div>
                  </div>
               </div>
            </div>
            <div class="md:col-span-12 lg:col-span-8 lg:order-2 order-1">
               <div class="gh-content prose prose-lg pb-8 dark:prose-invert">
                  {{content}}

                  <!-- Inline Table of Contents - will be moved after first paragraph by JavaScript -->
                  <div id="inline-toc-container"
                     class="inline-toc-widget bg-gray-50 dark:bg-slate-800 border border-gray-200 dark:border-white/10 rounded-lg p-6 my-8 hidden">
                     <p class="font-serif text-xl text-gray-800 dark:text-gray-100 font-bold mb-4 mt-0">
                        {{t "table-of-content"}}
                     </p>
                     <div class="gh-toc"></div>
                  </div>
               </div>

               <!-- Tags Section -->
               <div class="post-details-tags flex flex-wrap gap-4 mb-6">
                  {{#foreach tags visibility="public" limit="10"}}
                  <a href="{{url}}"
                     class="tag h-10 hover:shadow-md transform hover:-translate-y-0.5 group inline-flex items-center px-4 py-2 bg-gray-50 dark:bg-slate-800 hover:bg-white dark:hover:bg-slate-700 text-gray-600 dark:text-gray-300 hover:text-gray-800 dark:hover:text-gray-100 text-base font-medium rounded-md border border-gray-200 dark:border-white/10 hover:border-gray-300 dark:hover:border-white/20 transition-all duration-200">{{name}}</a>
                  {{/foreach}}
               </div>

               {{#if access}}
               <!-- Lesson Completion Toggle -->
               <div
                  class="lesson-completion-toggle mb-6 py-4 bg-white dark:bg-slate-900 border-t border-blue-200 dark:border-slate-700">
                  <div class="flex items-center justify-between gap-4">
                     <div class="mark-lesson-title flex-1 min-w-0">
                        <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-1 truncate">{{t
                           "mark-lesson-complete"}} ({{title}})</h3>
                     </div>
                     <div class="flex-shrink-0">
                        <button id="toggle-completion"
                           class="completion-btn gap-2 h-10 hover:shadow-md transform hover:-translate-y-0.5 group inline-flex items-center px-5 py-2 bg-gray-100 dark:bg-slate-800 text-gray-600 dark:text-gray-300 text-base font-medium rounded-lg border border-gray-300 dark:border-slate-600 transition-all duration-200">
                           <svg id="completion-icon" class="w-5 h-5" fill="none" stroke="currentColor"
                              viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7">
                              </path>
                           </svg>
                           <span id="completion-text">{{t "mark-as-complete"}}</span>
                        </button>
                     </div>
                  </div>
               </div>
               {{/if}}

               <!-- Comments Section -->
               <div class="w-full mt-8">
                  {{#if comments}}
                  {{comments}}
                  {{/if}}
               </div>
            </div>
         </div>
      </div>
   </section>
   {{/post}}

   <!-- Load Lessons via AJAX (copied from course page) -->
   <script>
      async function loadCourseLessons() {
         const lessonContainer = document.querySelector('[data-load-lessons="true"]');
         if (!lessonContainer) return;

         // Extract course ID from body classes (e.g., "tag-hash-course-id-1")
         const bodyClasses = document.body.className;
         const courseIdMatch = bodyClasses.match(/tag-(hash-course-id-[\d]+)/);
         if (!courseIdMatch) {
            console.error('No course ID found in body classes');
            return;
         }

         const courseId = courseIdMatch[1]; // e.g., "hash-course-id-1"

         try {
            // Get API key from Ghost Code Injection config
            const apiKey = window.ghostConfig?.apiKey || '1f06b81ddee9f42ffca580be1b';
            const siteUrl = '{{@site.url}}'.replace(/\/$/, ''); // Remove trailing slash
            const apiUrl = `${siteUrl}/ghost/api/content/posts/`;
            const params = new URLSearchParams({
               key: apiKey,
               filter: `tag:${courseId}+tag:hash-lesson`,
               include: 'tags,authors',
               order: 'published_at asc',
               limit: '100'
            });

            const response = await fetch(`${apiUrl}?${params}`);

            if (!response.ok) {
               throw new Error(`API Error: ${response.status}`);
            }

            const data = await response.json();

            if (data.posts && data.posts.length > 0) {
               const lessonsHTML = data.posts.map((post, index) => `
                  <li class="lesson-item mb-2">
                     <a href="${post.url}" class="lesson-box block p-4 rounded-xl border border-transparent hover:bg-blue-50 dark:hover:bg-slate-800 hover:border-blue-200 dark:hover:border-blue-900 transition-all duration-300" id="${post.slug}" data-lesson-slug="${post.slug}">
                        <div class="flex items-start gap-4">
                           <div class="lesson-icon flex-shrink-0">
                              <div class="w-10 h-10 rounded-lg bg-blue-50 dark:bg-slate-800 text-blue-500 dark:text-blue-400 flex items-center justify-center text-sm font-bold transition-all duration-300">
                                 ${index + 1}
                              </div>
                           </div>
                           <div class="flex-1 min-w-0">
                              <h4 class="text-sm font-medium text-gray-600 dark:text-gray-400 mb-1 transition-colors duration-300">${post.title}</h4>
                           </div>
                        </div>
                     </a>
                  </li>
               `).join('');

               lessonContainer.innerHTML = `
                  <div class="related-lesson pb-6">
                     <h3 class="text-xl font-bold text-gray-900 dark:text-white transition-colors duration-300 px-6 pt-6 pb-4 border-b border-gray-100 dark:border-white/10 flex items-center gap-2">
                        <span class="w-1 h-5 bg-blue-600 rounded-full"></span>
                        {{t "course-lessons"}}
                     </h3>
                     <ol class="lesson-list max-h-[60vh] overflow-y-auto custom-scrollbar px-4 pt-4">
                        ${lessonsHTML}
                     </ol>
                  </div>
               `;

               // Highlight active lesson after loading
               setTimeout(highlightActiveLesson, 100);
            } else {
               lessonContainer.innerHTML = `
                  <div class="no-lessons-message px-6 py-12 text-center">
                     <div class="mb-4 relative">
                        <div class="absolute inset-0 bg-blue-500/20 blur-xl rounded-full"></div>
                        <svg class="w-16 h-16 mx-auto text-blue-500 relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                        </svg>
                     </div>
                     <h4 class="text-lg font-bold text-gray-900 dark:text-white mb-2">{{t "no-lessons-title"}}</h4>
                     <p class="text-sm text-gray-500 dark:text-gray-400 max-w-[200px] mx-auto leading-relaxed">{{t "lessons-coming-soon"}}</p>
                  </div>
               `;
            }
         } catch (error) {
            console.error('Error loading lessons:', error);
            lessonContainer.innerHTML = `
               <div class="px-6 py-12 text-center">
                  <svg class="w-12 h-12 mx-auto text-red-500 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                  </svg>
                  <p class="text-sm text-red-500 mb-2">{{t "cannot-load-lessons"}}</p>
                  <p class="text-xs text-gray-500 dark:text-gray-400">{{t "error"}}: ${error.message}</p>
                  <p class="text-xs text-gray-400 dark:text-gray-500 mt-2">{{t "check-api-key"}}</p>
               </div>
            `;
         }
      }

      // Run when DOM is ready
      if (document.readyState === 'loading') {
         document.addEventListener('DOMContentLoaded', loadCourseLessons);
      } else {
         loadCourseLessons();
      }

      // Function to highlight active lesson
      function highlightActiveLesson() {
         const currentPath = window.location.pathname;
         // Extract slug from URL path (e.g., /lesson/identifying-business-opportunities/ -> identifying-business-opportunities)
         const currentSlug = currentPath.split('/').filter(segment => segment.length > 0).pop();

         const lessonItems = document.querySelectorAll('.lesson-box');

         lessonItems.forEach(item => {
            const lessonId = item.getAttribute('id'); // This is the slug from {{slug}}

            // Reset all items to inactive state first
            item.classList.remove('bg-blue-50', 'dark:bg-slate-800', 'border-blue-200', 'dark:border-blue-900');
            item.classList.add('border-transparent');

            // Reset icon container
            const iconContainer = item.querySelector('.lesson-icon > div');
            if (iconContainer) {
               iconContainer.classList.remove('bg-blue-600', 'text-white', 'shadow-lg', 'shadow-blue-500/30');
               iconContainer.classList.add('bg-blue-50', 'dark:bg-slate-800', 'text-blue-500', 'dark:text-blue-400');
            }

            // Reset title
            const title = item.querySelector('h4');
            if (title) {
               title.classList.remove('text-blue-700', 'dark:text-blue-400', 'font-bold');
               title.classList.add('text-gray-600', 'dark:text-gray-400', 'font-medium');
            }

            // Check if this lesson is the current one by matching slug with ID
            if (lessonId === currentSlug) {
               // This is the active lesson - add active state classes
               item.classList.remove('border-transparent');
               item.classList.add('bg-blue-50', 'dark:bg-slate-800', 'border-blue-200', 'dark:border-blue-900');

               // Update icon container with active style
               if (iconContainer) {
                  iconContainer.classList.remove('bg-blue-50', 'dark:bg-slate-800', 'text-blue-500', 'dark:text-blue-400');
                  iconContainer.classList.add('bg-blue-600', 'text-white', 'shadow-lg', 'shadow-blue-500/30');
               }

               // Update title
               if (title) {
                  title.classList.remove('text-gray-600', 'dark:text-gray-400', 'font-medium');
                  title.classList.add('text-blue-700', 'dark:text-blue-400', 'font-bold');
               }

               // Auto-scroll active lesson into view (within lesson list container only)
               setTimeout(() => {
                  item.scrollIntoView({
                     behavior: 'smooth',
                     block: 'center',
                     inline: 'nearest'
                  });
               }, 300); // Small delay to ensure DOM is fully rendered
            }
         });
      }
   </script>

   <!-- Inject Course Breadcrumb -->
   <script>
      document.addEventListener('DOMContentLoaded', async function () {
         // Try to extract course info from related-lesson section
         const relatedLesson = document.querySelector('.related-lesson');
         if (!relatedLesson) return;

         const courseTag = relatedLesson.getAttribute('data-course-tag');
         if (!courseTag) return;

         // Extract course ID number from tag (e.g., "hash-course-id-1" -> "1")
         const courseIdMatch = courseTag.match(/course-id-(\d+)/);
         if (!courseIdMatch) return;

         const courseId = courseIdMatch[1];

         // Try to find course link by checking all internal links
         // Course URL pattern: typically /postgresql-high-availability/ or similar
         // We'll search for a link that might be the course by looking at the page structure

         // Alternative: construct course URL from current lesson URL
         // Lesson URL pattern: /lesson/bai-1-.../ 
         // Course URL pattern: might be /course/name/ or just /name/

         // For now, let's try to find the course by looking at meta tags or page data
         const articleTags = Array.from(document.querySelectorAll('meta[property="article:tag"]'));
         const primaryTag = articleTags.length > 0 ? articleTags[0].content : null;

         if (primaryTag) {
            // Construct likely course URL: /course/{primary-tag-slug}/
            const courseUrl = `/course/${primaryTag}/`;
            const courseTitle = primaryTag.split('-').map(word =>
               word.charAt(0).toUpperCase() + word.slice(1)
            ).join(' ');

            // Update breadcrumb - use translation
            const breadcrumbItem = document.getElementById('course-breadcrumb-item');
            const breadcrumbLink = document.getElementById('course-breadcrumb-link');

            if (breadcrumbItem && breadcrumbLink) {
               breadcrumbLink.href = courseUrl;
               // Note: This will show "Courses" label from breadcrumb partial, title comes from data
               breadcrumbItem.style.display = 'flex';
            }
         }
      });
   </script>

   <!-- Course Progress JavaScript -->
   <script>
      // Translation strings
      const i18n = {
         markedComplete: '{{t "marked-complete"}}',
         markAsComplete: '{{t "mark-as-complete"}}',
         lessonsCompleted: '{{t "lessons-completed"}}'
      };

      class CourseProgress {
         constructor() {
            this.courseId = this.getCourseId();
            this.lessonId = this.getLessonId();
            this.completedLessons = this.loadCompletedLessons();
            this.totalLessons = this.getTotalLessons();
            this.init();
         }

         getCourseId() {
            // Method 1: Extract course ID from the hero-section (most reliable)
            const heroCourseElement = document.querySelector('[data-current-course-id]');
            if (heroCourseElement && heroCourseElement.dataset.currentCourseId) {
               return heroCourseElement.dataset.currentCourseId;
            }

            // Method 2: Extract course slug from hero-section as fallback
            const heroCourseSlug = document.querySelector('[data-current-course-slug]');
            if (heroCourseSlug && heroCourseSlug.dataset.currentCourseSlug) {
               return heroCourseSlug.dataset.currentCourseSlug;
            }

            // Method 3: Extract course ID from the sidebar (fallback)
            const courseContainer = document.querySelector('.related-lesson');
            if (courseContainer && courseContainer.dataset.courseId) {
               return courseContainer.dataset.courseId;
            }

            // Method 4: Try to get from the lesson's tags (if available)
            const lessonTags = this.getLessonTags();
            if (lessonTags && lessonTags.length > 0) {
               // Look for the course tag (usually the first internal tag)
               for (let tag of lessonTags) {
                  if (tag && tag !== 'lesson' && tag !== 'hash-lesson') {
                     return tag;
                  }
               }
            }

            // Method 5: Try to extract from URL or page context
            const pathParts = window.location.pathname.split('/');

            // Look for course identifier in URL
            for (let i = 0; i < pathParts.length; i++) {
               if (pathParts[i] === 'course' && pathParts[i + 1]) {
                  return pathParts[i + 1];
               }
            }

            return 'default-course';
         }

         getLessonTags() {
            // Try to get lesson tags from the current page
            const metaTags = document.querySelectorAll('meta[name="ghost:tag"]');
            if (metaTags.length > 0) {
               return Array.from(metaTags).map(tag => tag.content);
            }

            // Try to get from the page's data attributes
            const pageData = document.querySelector('[data-ghost-tags]');
            if (pageData && pageData.dataset.ghostTags) {
               return pageData.dataset.ghostTags.split(',').map(tag => tag.trim());
            }

            return null;
         }

         getLessonId() {
            // Extract lesson ID from current URL or page
            const pathParts = window.location.pathname.split('/');
            return pathParts[pathParts.length - 2] || 'default';
         }

         getTotalLessons() {
            return document.querySelectorAll('.lesson-box').length;
         }

         // Create unique key for course-lesson combination
         createCourseLessonKey(courseId, lessonId) {
            return `${courseId}_${lessonId}`;
         }

         loadCompletedLessons() {
            const storageKey = `course_${this.courseId}_completed`;
            const stored = localStorage.getItem(storageKey);
            return stored ? JSON.parse(stored) : {};
         }

         saveCompletedLessons() {
            const storageKey = `course_${this.courseId}_completed`;
            localStorage.setItem(storageKey, JSON.stringify(this.completedLessons));
         }

         toggleLessonCompletion() {
            // Use unique course-lesson key
            const courseLessonKey = this.createCourseLessonKey(this.courseId, this.lessonId);

            if (this.completedLessons[courseLessonKey]) {
               delete this.completedLessons[courseLessonKey];
            } else {
               this.completedLessons[courseLessonKey] = true;
            }
            this.saveCompletedLessons();
            this.updateUI();
            this.updateProgress();
         }

         updateUI() {
            // Use unique course-lesson key
            const courseLessonKey = this.createCourseLessonKey(this.courseId, this.lessonId);
            const isCompleted = this.completedLessons[courseLessonKey];

            const btn = document.getElementById('toggle-completion');
            const text = document.getElementById('completion-text');
            const icon = document.getElementById('completion-icon');

            if (btn) {
               if (isCompleted) {
                  // Completed state - Green with checkmark
                  btn.classList.remove('bg-gray-100', 'dark:bg-slate-800', 'text-gray-600', 'dark:text-gray-300', 'border-gray-300', 'dark:border-slate-600');
                  btn.classList.add('bg-green-500', 'dark:bg-green-600', 'text-white', 'border-green-600', 'dark:border-green-500', 'hover:bg-green-600', 'dark:hover:bg-green-700');
                  if (text) text.textContent = i18n.markedComplete;
                  if (icon) icon.style.display = 'block';
               } else {
                  // Incomplete state - Gray
                  btn.classList.remove('bg-green-500', 'dark:bg-green-600', 'text-white', 'border-green-600', 'dark:border-green-500', 'hover:bg-green-600', 'dark:hover:bg-green-700');
                  btn.classList.add('bg-gray-100', 'dark:bg-slate-800', 'text-gray-600', 'dark:text-gray-300', 'border-gray-300', 'dark:border-slate-600', 'hover:bg-gray-200', 'dark:hover:bg-slate-700');
                  if (text) text.textContent = i18n.markAsComplete;
                  if (icon) icon.style.display = 'none';
               }
            }

            // Update lesson list items
            this.updateLessonList();
         }

         updateLessonList() {
            const lessonItems = document.querySelectorAll('.lesson-box');
            lessonItems.forEach((item, index) => {
               const lessonSlug = item.dataset.lessonSlug || item.id;
               const iconContainer = item.querySelector('.lesson-icon > div');

               if (!iconContainer) return;

               // Use unique course-lesson key
               const courseLessonKey = this.createCourseLessonKey(this.courseId, lessonSlug);

               if (this.completedLessons[courseLessonKey]) {
                  // Show checkmark for completed lessons
                  iconContainer.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>';
                  iconContainer.classList.add('bg-green-100', 'dark:bg-green-900/30', 'text-green-600', 'dark:text-green-400');
                  iconContainer.classList.remove('bg-blue-50', 'dark:bg-slate-800', 'text-blue-500', 'dark:text-blue-400');
               } else {
                  // Show lesson number for incomplete lessons
                  iconContainer.innerHTML = index + 1;
                  iconContainer.classList.add('bg-blue-50', 'dark:bg-slate-800', 'text-blue-500', 'dark:text-blue-400');
                  iconContainer.classList.remove('bg-green-100', 'dark:bg-green-900/30', 'text-green-600', 'dark:text-green-400');
               }
            });
         }

         updateProgress() {
            const completedCount = Object.keys(this.completedLessons).length;
            const percentage = this.totalLessons > 0 ? Math.round((completedCount / this.totalLessons) * 100) : 0;

            // Update progress bar
            const progressFill = document.getElementById('progress-fill');
            const progressPercentage = document.getElementById('progress-percentage');
            const progressText = document.getElementById('progress-text');

            if (progressFill) progressFill.style.width = `${percentage}%`;
            if (progressPercentage) progressPercentage.textContent = `${percentage}%`;
            if (progressText) progressText.textContent = i18n.lessonsCompleted.replace(/%/g, (match, offset, string) => {
               // If there are two % symbols, replace first with completedCount, second with totalLessons
               if (offset === string.indexOf('%')) return completedCount;
               return this.totalLessons;
            });
         }

         init() {
            // Initialize completion button
            const toggleBtn = document.getElementById('toggle-completion');
            if (toggleBtn) {
               toggleBtn.addEventListener('click', () => this.toggleLessonCompletion());
            }

            // Set initial state
            this.updateUI();
            this.updateProgress();
         }
      }

      // Initialize when DOM is ready
      if (document.readyState === 'loading') {
         document.addEventListener('DOMContentLoaded', () => new CourseProgress());
      } else {
         new CourseProgress();
      }
   </script>

   <link rel="stylesheet" href="{{asset 'css/tocbot.css'}}" />
   <link rel="stylesheet" href="{{asset 'css/prism.css'}}" />
   <script src="{{asset 'js/tocbot.min.js'}}"></script>
   <script src="{{asset 'js/prism.js'}}" defer></script>
   <script>
      // Initialize Table of Contents
      document.addEventListener('DOMContentLoaded', function () {
         // Check if there are any headings in the content, excluding the upgrade CTA
         const contentHeadings = Array.from(document.querySelectorAll('.gh-content h2, .gh-content h3, .gh-content h4, .gh-content h5'))
            .filter(h => !h.closest('.gh-post-upgrade-cta'));

         if (contentHeadings.length === 0) {
            return;
         }

         // Check if tocbot is available
         if (typeof tocbot !== 'undefined') {
            tocbot.init({
               tocSelector: '.gh-toc',
               contentSelector: '.gh-content',
               headingSelector: 'h2, h3, h4, h5',
               ignoreSelector: '.js-no-anchor, .gh-post-upgrade-cta h2',
               headingsOffset: 100,
               scrollSmoothOffset: -100,
               maxHeaderLength: -1, // unlimited - don't truncate IDs
               onClick: false, // disable default tocbot click handler - use custom below
            });
            tocbot.refresh();

            // Check if tocbot actually generated any TOC items
            setTimeout(() => {
               const tocItems = document.querySelectorAll('li.toc-list-item');
               const tocContainer = document.getElementById('inline-toc-container');
               if (tocItems.length > 0 && tocContainer) {
                  // Show TOC container
                  tocContainer.classList.remove('hidden');

                  // Move TOC to the beginning of content (after first heading)
                  const firstHeading = document.querySelector('.gh-content > h2');
                  if (firstHeading && firstHeading.parentNode) {
                     firstHeading.parentNode.insertBefore(tocContainer, firstHeading.nextSibling);
                  }
               }

               // Add smooth scroll to TOC links - wait longer for tocbot to finish
               const attachSmoothScroll = () => {
                  const tocLinks = document.querySelectorAll('.gh-toc a');
                  if (tocLinks.length === 0) {
                     // Tocbot hasn't generated links yet, retry
                     setTimeout(attachSmoothScroll, 200);
                     return;
                  }

                  tocLinks.forEach(link => {
                     // Use capture phase to run before default behavior
                     link.addEventListener('click', function (e) {
                        e.preventDefault();
                        e.stopPropagation();

                        const href = this.getAttribute('href');
                        const targetId = href.startsWith('#') ? href.substring(1) : href;
                        const targetElement = document.getElementById(targetId);

                        if (targetElement) {
                           // Use native scroll with offset for better performance
                           const offsetTop = targetElement.getBoundingClientRect().top + window.pageYOffset - 100;
                           window.scrollTo({
                              top: offsetTop,
                              behavior: 'smooth'
                           });

                           // Update URL hash without jumping
                           if (history.pushState) {
                              history.pushState(null, null, href);
                           }
                        }

                        return false;
                     }, true); // true = capture phase
                  });
               };

               attachSmoothScroll();
            }, 100);
         }
      });
   </script>