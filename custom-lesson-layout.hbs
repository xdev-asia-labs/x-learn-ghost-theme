{{!< default}} {{#post}} {{!-- Get course using primary tag --}} {{#primary_tag}} {{#get "posts" limit="1"
   filter="primary_tag:{{slug}}+tag:hash-course" }} {{#foreach posts}} <div style="display:none" id="course-info-data"
   data-course-title="{{title}}" data-course-url="{{url}}">
   </div>
   {{/foreach}}
   {{/get}}
   {{/primary_tag}}

   {{!-- Breadcrumb Navigation --}}
   {{> breadcrumb}}

   {{!-- Hero Section - always show for lessons --}}
   {{> hero-section lesson_style="image_on_right"}}

   <section class="single-lesson-area pt-8 md:pt-10 lg:pt-16">
      <div class="container mx-auto">
         <div class="grid grid-cols-1 md:grid-cols-12 gap-4 md:gap-6 lg:gap-8">
            <div class="md:col-span-12 lg:col-span-4 lg:order-1 order-2">
               <div class="lesson-list-sidebar sticky top-8">
                  <div class="sidebar rounded-lg shadow duration-300">
                     <div class="left-lesson-list">
                        <!-- Lesson list container with loading state -->
                        <div class="lessons-container" data-load-lessons="true">
                           <h3
                              class="text-2xl font-bold text-gray-800 group-hover:text-blue-800 transition-colors duration-300 px-6 pt-6 pb-6">
                              {{t "course-lessons"}}
                           </h3>

                           {{#if access}}
                           <!-- Course Progress Section -->
                           <div class="course-progress px-6 pb-6 smooth-fade-in">
                              <div class="progress-stats flex justify-between items-center mb-2">
                                 <span class="text-sm text-gray-400">{{t "progress"}}</span>
                                 <span class="text-sm font-medium text-blue-800" id="progress-percentage">0%</span>
                              </div>
                              <div class="progress-bar bg-gray-200 rounded-full h-2 mb-2">
                                 <div class="progress-fill bg-blue-800 h-2 rounded-full transition-all duration-300"
                                    id="progress-fill" style="width: 0%"></div>
                              </div>
                              <div class="progress-text text-xs text-gray-400" id="progress-text">0 of 0 lessons
                                 completed</div>
                           </div>
                           {{/if}}

                           <!-- Loading indicator -->
                           <div class="lessons-loading px-6 py-4 text-center text-gray-500">
                              <svg class="animate-spin h-8 w-8 mx-auto mb-2" xmlns="http://www.w3.org/2000/svg"
                                 fill="none" viewBox="0 0 24 24">
                                 <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                    stroke-width="4"></circle>
                                 <path class="opacity-75" fill="currentColor"
                                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                 </path>
                              </svg>
                              <p>{{t "loading"}}...</p>
                           </div>

                           <!-- Lessons will be loaded here -->
                           <ol class="lesson-list" style="display:none;"></ol>
                        </div>
                     </div>
                  </div>
               </div>
            </div>
            <div class="md:col-span-12 lg:col-span-8 lg:order-2 order-1">
               <div class="gh-content prose prose-lg pb-8 dark:prose-invert">
                  {{content}}

                  <!-- Inline Table of Contents - will be moved after first paragraph by JavaScript -->
                  <div id="inline-toc-container"
                     class="inline-toc-widget bg-gray-50 dark:bg-slate-800 border border-gray-200 dark:border-white/10 rounded-lg p-6 my-8 hidden">
                     <p class="font-serif text-xl text-gray-800 dark:text-gray-100 font-bold mb-4 mt-0">
                        {{t "table-of-content"}}
                     </p>
                     <div class="gh-toc"></div>
                  </div>
               </div>

               <!-- Tags Section -->
               <div class="post-details-tags flex flex-wrap gap-4 mb-6">
                  {{#foreach tags visibility="public" limit="10"}}
                  <a href="{{url}}"
                     class="tag h-10 hover:shadow-md transform hover:-translate-y-0.5 group inline-flex items-center px-4 py-2 bg-gray-50 dark:bg-slate-800 hover:bg-white dark:hover:bg-slate-700 text-gray-600 dark:text-gray-300 hover:text-gray-800 dark:hover:text-gray-100 text-base font-medium rounded-md border border-gray-200 dark:border-white/10 hover:border-gray-300 dark:hover:border-white/20 transition-all duration-200">{{name}}</a>
                  {{/foreach}}
               </div>

               {{#if access}}
               <!-- Lesson Completion Toggle -->
               <div
                  class="lesson-completion-toggle mb-6 py-4 bg-white dark:bg-slate-900 border-t border-blue-200 dark:border-slate-700">
                  <div class="flex items-center justify-between gap-4">
                     <div class="mark-lesson-title flex-1 min-w-0">
                        <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-1 truncate">{{t
                           "mark-lesson-complete"}} ({{title}})</h3>
                     </div>
                     <div class="flex-shrink-0">
                        <button id="toggle-completion"
                           class="completion-btn gap-2 h-10 hover:shadow-md transform hover:-translate-y-0.5 group inline-flex items-center px-5 py-2 bg-gray-100 dark:bg-slate-800 text-gray-600 dark:text-gray-300 text-base font-medium rounded-lg border border-gray-300 dark:border-slate-600 transition-all duration-200">
                           <svg id="completion-icon" class="w-5 h-5" fill="none" stroke="currentColor"
                              viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7">
                              </path>
                           </svg>
                           <span id="completion-text">{{t "mark-as-complete"}}</span>
                        </button>
                     </div>
                  </div>
               </div>
               {{/if}}

               <!-- Comments Section -->
               <div class="w-full mt-8">
                  {{#if comments}}
                  {{comments}}
                  {{/if}}
               </div>
            </div>
         </div>
      </div>
   </section>
   {{/post}}

   <!-- Load Lessons via AJAX -->
   <script>
      document.addEventListener('DOMContentLoaded', async function () {
         const lessonsContainer = document.querySelector('[data-load-lessons="true"]');
         if (!lessonsContainer) return;

         // Extract course ID from body classes (same as course page)
         const bodyClasses = document.body.className;
         const courseIdMatch = bodyClasses.match(/tag-(hash-course-id-[\w-]+)/);

         if (!courseIdMatch) {
            console.error('No course ID found in body classes');
            return;
         }

         const courseId = courseIdMatch[1];
         await loadCourseLessons(courseId);
      });

      async function loadCourseLessons(courseId) {
         const apiKey = window.ghostConfig?.apiKey || '1f06b81ddee9f42ffca580be1b';
         const apiUrl = window.location.origin;
         const lessonsContainer = document.querySelector('[data-load-lessons="true"]');
         const loadingIndicator = lessonsContainer.querySelector('.lessons-loading');
         const lessonList = lessonsContainer.querySelector('.lesson-list');

         try {
            // Fetch lessons from Ghost Content API
            const response = await fetch(`${apiUrl}/ghost/api/content/posts/?key=${apiKey}&filter=tag:${courseId}+tag:hash-lesson&include=tags,authors,tiers&limit=all&order=published_at asc`);

            if (!response.ok) {
               throw new Error(`API request failed: ${response.status}`);
            }

            const data = await response.json();
            const lessons = data.posts || [];

            if (lessons.length === 0) {
               loadingIndicator.innerHTML = '<p class="text-gray-500 px-6 py-4">Chưa có bài học nào.</p>';
               return;
            }

            // Generate lesson list HTML
            let lessonsHTML = '';
            lessons.forEach((lesson, index) => {
               const lessonNumber = index + 1;
               const lessonSlug = lesson.slug;
               const lessonTitle = lesson.title;
               const lessonUrl = lesson.url;
               const isCurrentLesson = window.location.pathname.includes(lessonSlug);

               lessonsHTML += `
                  <li class="lesson-box ${isCurrentLesson ? 'active' : ''}" data-lesson-slug="${lessonSlug}">
                     <a href="${lessonUrl}" class="lesson-link">
                        <div class="lesson-logo">
                           <svg width="30" height="30" viewBox="0 0 30 30" fill="none" xmlns="http://www.w3.org/2000/svg">
                              <path d="M11.25 20.2125L6.0375 15L4.2625 16.7625L11.25 23.75L26.25 8.75L24.4875 6.9875L11.25 20.2125Z" fill="currentcolor"/>
                           </svg>
                        </div>
                        <div class="lesson-content">
                           <span class="lesson-number">${lessonNumber}</span>
                           <h4 class="lesson-title">${lessonTitle}</h4>
                        </div>
                     </a>
                  </li>
               `;
            });

            // Update UI
            lessonList.innerHTML = lessonsHTML;
            loadingIndicator.style.display = 'none';
            lessonList.style.display = 'block';

         } catch (error) {
            console.error('Error loading lessons:', error);
            loadingIndicator.innerHTML = '<p class="text-red-500 px-6 py-4">Không thể tải danh sách bài học. Vui lòng thử lại sau.</p>';
         }
      }
   </script>

   <!-- Inject Course Breadcrumb -->
   <script>
      document.addEventListener('DOMContentLoaded', async function () {
         // Try to extract course info from related-lesson section
         const relatedLesson = document.querySelector('.related-lesson');
         if (!relatedLesson) return;

         const courseTag = relatedLesson.getAttribute('data-course-tag');
         if (!courseTag) return;

         // Extract course ID number from tag (e.g., "hash-course-id-1" -> "1")
         const courseIdMatch = courseTag.match(/course-id-(\d+)/);
         if (!courseIdMatch) return;

         const courseId = courseIdMatch[1];

         // Try to find course link by checking all internal links
         // Course URL pattern: typically /postgresql-high-availability/ or similar
         // We'll search for a link that might be the course by looking at the page structure

         // Alternative: construct course URL from current lesson URL
         // Lesson URL pattern: /lesson/bai-1-.../ 
         // Course URL pattern: might be /course/name/ or just /name/

         // For now, let's try to find the course by looking at meta tags or page data
         const articleTags = Array.from(document.querySelectorAll('meta[property="article:tag"]'));
         const primaryTag = articleTags.length > 0 ? articleTags[0].content : null;

         if (primaryTag) {
            // Construct likely course URL: /course/{primary-tag-slug}/
            const courseUrl = `/course/${primaryTag}/`;
            const courseTitle = primaryTag.split('-').map(word =>
               word.charAt(0).toUpperCase() + word.slice(1)
            ).join(' ');

            // Update breadcrumb
            const breadcrumbItem = document.getElementById('course-breadcrumb-item');
            const breadcrumbLink = document.getElementById('course-breadcrumb-link');

            if (breadcrumbItem && breadcrumbLink) {
               breadcrumbLink.href = courseUrl;
               breadcrumbLink.textContent = `Khóa học ${courseTitle}`;
               breadcrumbItem.style.display = 'flex';
            }
         }
      });
   </script>

   <!-- Course Progress JavaScript -->
   <script>
      // Translation strings
      const i18n = {
         markedComplete: '{{t "marked-complete"}}',
         markAsComplete: '{{t "mark-as-complete"}}',
         lessonsCompleted: '{{t "lessons-completed"}}'
      };

      class CourseProgress {
         constructor() {
            this.courseId = this.getCourseId();
            this.lessonId = this.getLessonId();
            this.completedLessons = this.loadCompletedLessons();
            this.totalLessons = this.getTotalLessons();
            this.init();
         }

         getCourseId() {
            // Method 1: Extract course ID from the hero-section (most reliable)
            const heroCourseElement = document.querySelector('[data-current-course-id]');
            if (heroCourseElement && heroCourseElement.dataset.currentCourseId) {
               return heroCourseElement.dataset.currentCourseId;
            }

            // Method 2: Extract course slug from hero-section as fallback
            const heroCourseSlug = document.querySelector('[data-current-course-slug]');
            if (heroCourseSlug && heroCourseSlug.dataset.currentCourseSlug) {
               return heroCourseSlug.dataset.currentCourseSlug;
            }

            // Method 3: Extract course ID from the sidebar (fallback)
            const courseContainer = document.querySelector('.related-lesson');
            if (courseContainer && courseContainer.dataset.courseId) {
               return courseContainer.dataset.courseId;
            }

            // Method 4: Try to get from the lesson's tags (if available)
            const lessonTags = this.getLessonTags();
            if (lessonTags && lessonTags.length > 0) {
               // Look for the course tag (usually the first internal tag)
               for (let tag of lessonTags) {
                  if (tag && tag !== 'lesson' && tag !== 'hash-lesson') {
                     return tag;
                  }
               }
            }

            // Method 5: Try to extract from URL or page context
            const pathParts = window.location.pathname.split('/');

            // Look for course identifier in URL
            for (let i = 0; i < pathParts.length; i++) {
               if (pathParts[i] === 'course' && pathParts[i + 1]) {
                  return pathParts[i + 1];
               }
            }

            return 'default-course';
         }

         getLessonTags() {
            // Try to get lesson tags from the current page
            const metaTags = document.querySelectorAll('meta[name="ghost:tag"]');
            if (metaTags.length > 0) {
               return Array.from(metaTags).map(tag => tag.content);
            }

            // Try to get from the page's data attributes
            const pageData = document.querySelector('[data-ghost-tags]');
            if (pageData && pageData.dataset.ghostTags) {
               return pageData.dataset.ghostTags.split(',').map(tag => tag.trim());
            }

            return null;
         }

         getLessonId() {
            // Extract lesson ID from current URL or page
            const pathParts = window.location.pathname.split('/');
            return pathParts[pathParts.length - 2] || 'default';
         }

         getTotalLessons() {
            return document.querySelectorAll('.lesson-box').length;
         }

         // Create unique key for course-lesson combination
         createCourseLessonKey(courseId, lessonId) {
            return `${courseId}_${lessonId}`;
         }

         loadCompletedLessons() {
            const storageKey = `course_${this.courseId}_completed`;
            const stored = localStorage.getItem(storageKey);
            return stored ? JSON.parse(stored) : {};
         }

         saveCompletedLessons() {
            const storageKey = `course_${this.courseId}_completed`;
            localStorage.setItem(storageKey, JSON.stringify(this.completedLessons));
         }

         toggleLessonCompletion() {
            // Use unique course-lesson key
            const courseLessonKey = this.createCourseLessonKey(this.courseId, this.lessonId);

            if (this.completedLessons[courseLessonKey]) {
               delete this.completedLessons[courseLessonKey];
            } else {
               this.completedLessons[courseLessonKey] = true;
            }
            this.saveCompletedLessons();
            this.updateUI();
            this.updateProgress();
         }

         updateUI() {
            // Use unique course-lesson key
            const courseLessonKey = this.createCourseLessonKey(this.courseId, this.lessonId);
            const isCompleted = this.completedLessons[courseLessonKey];

            const btn = document.getElementById('toggle-completion');
            const text = document.getElementById('completion-text');
            const icon = document.getElementById('completion-icon');

            if (isCompleted) {
               // Completed state - Green with checkmark
               btn.classList.remove('bg-gray-100', 'dark:bg-slate-800', 'text-gray-600', 'dark:text-gray-300', 'border-gray-300', 'dark:border-slate-600');
               btn.classList.add('bg-green-500', 'dark:bg-green-600', 'text-white', 'border-green-600', 'dark:border-green-500', 'hover:bg-green-600', 'dark:hover:bg-green-700');
               text.textContent = i18n.markedComplete;
               if (icon) {
                  icon.style.display = 'block';
               }
            } else {
               // Incomplete state - Gray
               btn.classList.remove('bg-green-500', 'dark:bg-green-600', 'text-white', 'border-green-600', 'dark:border-green-500', 'hover:bg-green-600', 'dark:hover:bg-green-700');
               btn.classList.add('bg-gray-100', 'dark:bg-slate-800', 'text-gray-600', 'dark:text-gray-300', 'border-gray-300', 'dark:border-slate-600', 'hover:bg-gray-200', 'dark:hover:bg-slate-700');
               text.textContent = i18n.markAsComplete;
               if (icon) {
                  icon.style.display = 'none';
               }
            }

            // Update lesson list items
            this.updateLessonList();
         }

         updateLessonList() {
            const lessonItems = document.querySelectorAll('.lesson-box');
            lessonItems.forEach(item => {
               const lessonSlug = item.dataset.lessonSlug;
               const iconContainer = item.querySelector('.lesson-logo');

               // Use unique course-lesson key
               const courseLessonKey = this.createCourseLessonKey(this.courseId, lessonSlug);

               if (this.completedLessons[courseLessonKey]) {
                  // Show checkmark for completed lessons
                  iconContainer.innerHTML = '<svg width="30" height="30" viewBox="0 0 30 30" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M11.25 20.2125L6.0375 15L4.2625 16.7625L11.25 23.75L26.25 8.75L24.4875 6.9875L11.25 20.2125Z" fill="currentcolor"/></svg>';
                  iconContainer.classList.add('bg-green-100', 'dark:bg-green-900/30', 'text-green-600', 'dark:text-green-400');
                  iconContainer.classList.remove('bg-gray-200', 'dark:bg-slate-700', 'text-gray-400', 'dark:text-gray-500', 'bg-blue-50', 'dark:bg-blue-900/30');


               } else {
                  // Show lesson icon for incomplete lessons
                  iconContainer.innerHTML = '<svg width="30" height="30" viewBox="0 0 30 30" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M11.25 20.2125L6.0375 15L4.2625 16.7625L11.25 23.75L26.25 8.75L24.4875 6.9875L11.25 20.2125Z" fill="currentcolor"/></svg>';
                  iconContainer.classList.add('bg-gray-200', 'dark:bg-slate-700', 'text-gray-500', 'dark:text-gray-400');
                  iconContainer.classList.remove('bg-green-100', 'dark:bg-green-900/30', 'text-green-600', 'dark:text-green-400', 'bg-blue-50', 'dark:bg-blue-900/30');

                  // Remove completion indicator
                  const indicator = item.querySelector('.completion-indicator');
                  if (indicator) indicator.remove();
               }
            });
         }

         updateProgress() {
            const completedCount = Object.keys(this.completedLessons).length;
            const percentage = this.totalLessons > 0 ? Math.round((completedCount / this.totalLessons) * 100) : 0;

            // Update progress bar
            const progressFill = document.getElementById('progress-fill');
            const progressPercentage = document.getElementById('progress-percentage');
            const progressText = document.getElementById('progress-text');

            if (progressFill) progressFill.style.width = `${percentage}%`;
            if (progressPercentage) progressPercentage.textContent = `${percentage}%`;
            if (progressText) progressText.textContent = i18n.lessonsCompleted.replace(/%/g, (match, offset, string) => {
               // If there are two % symbols, replace first with completedCount, second with totalLessons
               if (offset === string.indexOf('%')) return completedCount;
               return this.totalLessons;
            });
         }

         init() {
            // Initialize completion button
            const toggleBtn = document.getElementById('toggle-completion');
            if (toggleBtn) {
               toggleBtn.addEventListener('click', () => this.toggleLessonCompletion());
            }

            // Set initial state
            this.updateUI();
            this.updateProgress();
         }
      }

      // Initialize when DOM is ready
      if (document.readyState === 'loading') {
         document.addEventListener('DOMContentLoaded', () => new CourseProgress());
      } else {
         new CourseProgress();
      }
   </script>

   <link rel="stylesheet" href="{{asset 'css/tocbot.css'}}" />
   <link rel="stylesheet" href="{{asset 'css/prism.css'}}" />
   <script src="{{asset 'js/tocbot.min.js'}}"></script>
   <script src="{{asset 'js/prism.js'}}" defer></script>
   <script>
      // Initialize Table of Contents
      document.addEventListener('DOMContentLoaded', function () {
         // Check if there are any headings in the content
         const contentHeadings = document.querySelectorAll('.gh-content h2, .gh-content h3, .gh-content h4, .gh-content h5');

         if (contentHeadings.length === 0) {
            return;
         }

         // Check if tocbot is available
         if (typeof tocbot !== 'undefined') {
            tocbot.init({
               tocSelector: '.gh-toc',
               contentSelector: '.gh-content',
               headingSelector: 'h2, h3, h4, h5',
               ignoreSelector: '.js-no-anchor',
               headingsOffset: 100,
               scrollSmoothOffset: -100,
               maxHeaderLength: -1, // unlimited - don't truncate IDs
               onClick: false, // disable default tocbot click handler - use custom below
            });
            tocbot.refresh();

            // Check if tocbot actually generated any TOC items
            setTimeout(() => {
               const tocItems = document.querySelectorAll('li.toc-list-item');
               const tocContainer = document.getElementById('inline-toc-container');
               if (tocItems.length > 0 && tocContainer) {
                  // Show TOC container
                  tocContainer.classList.remove('hidden');

                  // Move TOC to the beginning of content (after first heading)
                  const firstHeading = document.querySelector('.gh-content > h2');
                  if (firstHeading && firstHeading.parentNode) {
                     firstHeading.parentNode.insertBefore(tocContainer, firstHeading.nextSibling);
                  }
               }

               // Add smooth scroll to TOC links - wait longer for tocbot to finish
               const attachSmoothScroll = () => {
                  const tocLinks = document.querySelectorAll('.gh-toc a');
                  if (tocLinks.length === 0) {
                     // Tocbot hasn't generated links yet, retry
                     setTimeout(attachSmoothScroll, 200);
                     return;
                  }

                  tocLinks.forEach(link => {
                     // Use capture phase to run before default behavior
                     link.addEventListener('click', function (e) {
                        e.preventDefault();
                        e.stopPropagation();

                        const href = this.getAttribute('href');
                        const targetId = href.startsWith('#') ? href.substring(1) : href;
                        const targetElement = document.getElementById(targetId);

                        if (targetElement) {
                           // Use native scroll with offset for better performance
                           const offsetTop = targetElement.getBoundingClientRect().top + window.pageYOffset - 100;
                           window.scrollTo({
                              top: offsetTop,
                              behavior: 'smooth'
                           });

                           // Update URL hash without jumping
                           if (history.pushState) {
                              history.pushState(null, null, href);
                           }
                        }

                        return false;
                     }, true); // true = capture phase
                  });
               };

               attachSmoothScroll();
            }, 100);
         }
      });
   </script>