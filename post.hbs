{{!< default}} {{#post}} {{!-- Breadcrumb Navigation --}} {{> breadcrumb}}

   {{> hero-section post_style="image_on_right"}}

   <section class="single-area pb-8 md:pb-10 lg:pb-16 relative z-10">
      <!-- Background Decoration -->
      <div
         class="absolute top-0 left-0 w-full h-96 bg-gradient-to-b from-gray-50/50 to-transparent dark:from-slate-900/50 dark:to-transparent pointer-events-none -z-10">
      </div>

      <div class="container mx-auto">
         <div class="grid grid-cols-1 md:grid-cols-12 gap-8 lg:gap-12">
            <div class="md:col-span-12 lg:col-span-8">
               <div
                  class="gh-content prose prose-lg pb-8 dark:prose-invert max-w-none prose-headings:font-serif prose-headings:font-bold prose-a:text-blue-600 dark:prose-a:text-blue-400 prose-img:rounded-xl prose-img:shadow-lg">
                  {{content}}
               </div>

               <!-- Floating TOC Button (Bottom Right) - Shifted up to avoid ScrollTop overlap -->
               <button id="toc-floating-btn"
                  class="fixed right-6 bottom-24 z-50 bg-gradient-to-tr from-blue-600 to-blue-500 hover:from-blue-700 hover:to-blue-600 text-white rounded-2xl shadow-lg hover:shadow-blue-500/30 ring-1 ring-white/20 transition-all duration-300 flex items-center justify-center group hidden hover:-translate-y-1"
                  style="width: 56px; height: 56px; min-width: 56px; min-height: 56px;"
                  aria-label="{{t 'table-of-content'}}">
                  <svg class="w-7 h-7 toc-icon-open transition-transform duration-300 group-hover:scale-110" fill="none"
                     stroke="currentColor" viewBox="0 0 24 24">
                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7">
                     </path>
                  </svg>
                  <svg class="w-7 h-7 toc-icon-close hidden transition-transform duration-300 text-white" fill="none"
                     stroke="currentColor" viewBox="0 0 24 24">
                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                     </path>
                  </svg>
               </button>

               <!-- Floating TOC Panel (Bottom Right, Floating Card) - Shifted up -->
               <div id="toc-floating-panel"
                  class="fixed right-6 bottom-44 z-40 w-80 max-h-[60vh] bg-white/90 dark:bg-slate-900/90 backdrop-blur-xl border border-gray-200/50 dark:border-white/10 rounded-2xl shadow-2xl transform translate-y-20 opacity-0 pointer-events-none transition-all duration-300 cubic-bezier(0.16, 1, 0.3, 1) flex flex-col overflow-hidden">
                  <div
                     class="px-5 py-4 border-b border-gray-100/50 dark:border-gray-800/50 bg-gray-50/50 dark:bg-slate-800/50">
                     <p
                        class="font-serif text-lg text-gray-800 dark:text-gray-100 font-bold m-0 flex items-center gap-2">
                        <span
                           class="flex items-center justify-center w-8 h-8 rounded-lg bg-blue-100 dark:bg-blue-900/50 text-blue-600 dark:text-blue-400">
                           <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                 d="M4 6h16M4 12h16M4 18h7"></path>
                           </svg>
                        </span>
                        {{t "table-of-content"}}
                     </p>
                  </div>
                  <div class="gh-toc p-2 overflow-y-auto custom-scrollbar"></div>
                  <!-- Gradient overlay at bottom to hint scroll -->
                  <div
                     class="absolute bottom-0 left-0 w-full h-8 bg-gradient-to-t from-white dark:from-slate-900 to-transparent pointer-events-none">
                  </div>
               </div>

               <!-- add tags -->
               <div
                  class="post-details-tags flex flex-wrap gap-3 mt-8 border-t border-gray-100 dark:border-gray-800 pt-8">
                  {{#foreach tags limit="5"}}
                  <a href="{{url}}"
                     class="tag h-9 hover:shadow-lg hover:-translate-y-0.5 group inline-flex items-center px-4 py-1 bg-white dark:bg-slate-800 hover:bg-blue-50 dark:hover:bg-blue-900/30 text-gray-600 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 text-sm font-bold rounded-full border border-gray-200 dark:border-gray-700 hover:border-blue-200 dark:hover:border-blue-500/50 transition-all duration-300">
                     <span class="mr-1.5 opacity-50">#</span>{{name}}
                  </a>
                  {{/foreach}}
               </div>
               <div class="social-share-post mt-8">
                  {{> social-share}}
               </div>

               <!-- Comments Section -->
               <div class="w-full mt-12">
                  {{#if comments}}
                  <div
                     class="bg-gray-50 dark:bg-slate-900/50 rounded-2xl p-6 md:p-8 border border-gray-100 dark:border-gray-800">
                     {{comments}}
                  </div>
                  {{/if}}
               </div>

            </div>
            <div class="post-sidebar md:col-span-12 lg:col-span-4 smooth-fade-in">


               <!-- Recent Posts Widget -->
               <div
                  class="sidebar sticky top-24 rounded-2xl p-6 lg:p-8 glass-apple-card glass-noise border border-gray-100 dark:border-white/10 shadow-xl dark:shadow-none">
                  <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-6 flex items-center gap-2">
                     <span class="w-1 h-6 bg-blue-600 rounded-full"></span>
                     {{t "recent-posts"}}
                  </h3>
                  {{> recent-posts}}
               </div>
            </div>
         </div>
      </div>
   </section>
   {{/post}}
   <div class="container mx-auto">
      {{> related-content}}
   </div>
   <link rel="stylesheet" href="{{asset 'css/tocbot.css'}}" />
   <link rel="stylesheet" href="{{asset 'css/prism.css'}}" />
   <script src="{{asset 'js/tocbot.min.js'}}"></script>
   <script src="{{asset 'js/prism.js'}}" defer></script>
   <script>
      // Wait for DOM to be ready and tocbot to load
      document.addEventListener('DOMContentLoaded', function () {
         // Function to generate a slug from text (supports Vietnamese)
         function generateHeadingId(text) {
            return text
               .toLowerCase()
               .normalize('NFD') // Normalize to decomposed form
               .replace(/[\u0300-\u036f]/g, '') // Remove diacritics
               .replace(/đ/g, 'd').replace(/Đ/g, 'd') // Handle Vietnamese đ
               .replace(/[^a-z0-9\s-]/g, '') // Remove special characters
               .replace(/\s+/g, '-') // Replace spaces with hyphens
               .replace(/-+/g, '-') // Replace multiple hyphens with single
               .replace(/^-|-$/g, '') // Remove leading/trailing hyphens
               .substring(0, 100); // Limit length
         }

         // Always regenerate clean slugified IDs for all headings
         const usedIds = new Set();
         document.querySelectorAll('.gh-content h1, .gh-content h2, .gh-content h3, .gh-content h4, .gh-content h5, .gh-content h6').forEach(heading => {
            let baseId = generateHeadingId(heading.textContent) || 'heading';
            let id = baseId;
            let counter = 1;
            // Ensure unique ID
            while (usedIds.has(id)) {
               id = baseId + '-' + counter;
               counter++;
            }
            heading.id = id;
            usedIds.add(id);
         });

         // Check if there are any headings in the content, excluding the upgrade CTA
         const contentHeadings = Array.from(document.querySelectorAll('.gh-content h2, .gh-content h3, .gh-content h4, .gh-content h5'))
            .filter(h => !h.closest('.gh-post-upgrade-cta'));

         const floatingBtn = document.getElementById('toc-floating-btn');
         const floatingPanel = document.getElementById('toc-floating-panel');
         const iconOpen = floatingBtn?.querySelector('.toc-icon-open');
         const iconClose = floatingBtn?.querySelector('.toc-icon-close');

         if (contentHeadings.length === 0) {
            // No headings found, hide floating TOC button
            if (floatingBtn) floatingBtn.style.display = 'none';
            if (floatingPanel) floatingPanel.style.display = 'none';
            return;
         }

         // Show the floating button
         if (floatingBtn) {
            floatingBtn.classList.remove('hidden');
         }

         let isPanelOpen = false;

         function togglePanel() {
            isPanelOpen = !isPanelOpen;
            if (isPanelOpen) {
               // Open: Fade in, scale up, slide up slightly
               floatingPanel.classList.remove('opacity-0', 'pointer-events-none', 'translate-y-20');
               floatingPanel.classList.add('opacity-100', 'pointer-events-auto', 'translate-y-0');

               // Icon animation
               iconOpen.classList.add('scale-0', 'opacity-0');
               iconOpen.classList.remove('scale-100', 'opacity-100');
               setTimeout(() => {
                  iconOpen.classList.add('hidden');
                  iconClose.classList.remove('hidden');
                  // Small delay to allow transition
                  requestAnimationFrame(() => {
                     iconClose.classList.remove('rotate-[-90deg]', 'opacity-0');
                     iconClose.classList.add('rotate-0', 'opacity-100');
                  });
               }, 150);
            } else {
               // Close: Fade out, slide down
               floatingPanel.classList.remove('opacity-100', 'pointer-events-auto', 'translate-y-0');
               floatingPanel.classList.add('opacity-0', 'pointer-events-none', 'translate-y-20');

               // Icon animation
               iconClose.classList.add('rotate-[-90deg]', 'opacity-0');
               iconClose.classList.remove('rotate-0', 'opacity-100');
               setTimeout(() => {
                  iconClose.classList.add('hidden');
                  iconOpen.classList.remove('hidden');
                  requestAnimationFrame(() => {
                     iconOpen.classList.remove('scale-0', 'opacity-0');
                     iconOpen.classList.add('scale-100', 'opacity-100');
                  });
               }, 150);
            }
         }

         function closePanel() {
            if (isPanelOpen) {
               isPanelOpen = false;
               floatingPanel.classList.remove('opacity-100', 'pointer-events-auto', 'translate-y-0');
               floatingPanel.classList.add('opacity-0', 'pointer-events-none', 'translate-y-20');

               // Reset icons
               iconClose.classList.add('rotate-[-90deg]', 'opacity-0');
               iconClose.classList.remove('rotate-0', 'opacity-100');
               setTimeout(() => {
                  iconClose.classList.add('hidden');
                  iconOpen.classList.remove('hidden');
                  requestAnimationFrame(() => {
                     iconOpen.classList.remove('scale-0', 'opacity-0');
                     iconOpen.classList.add('scale-100', 'opacity-100');
                  });
               }, 150);
            }
         }

         // Toggle panel on button click
         if (floatingBtn) {
            floatingBtn.addEventListener('click', togglePanel);
         }

         // Close panel when clicking outside
         document.addEventListener('click', function (e) {
            if (isPanelOpen && !floatingPanel.contains(e.target) && !floatingBtn.contains(e.target)) {
               closePanel();
            }
         });

         // Check if tocbot is available
         if (typeof tocbot !== 'undefined') {
            tocbot.init({
               tocSelector: '.gh-toc',
               contentSelector: '.gh-content',
               headingSelector: 'h2, h3, h4, h5',
               // For headings inside relative or absolute positioned containers within content.
               ignoreSelector: '.js-no-anchor, .gh-post-upgrade-cta h2',
               headingsOffset: 100,
               scrollSmoothOffset: -100,
               maxHeaderLength: -1, // unlimited - don't truncate IDs for long Vietnamese headings
               onClick: false, // disable default tocbot click handler to use custom implementation
            });
            tocbot.refresh();

            // Custom smooth scroll implementation with retry logic
            const attachSmoothScroll = () => {
               const tocLinks = document.querySelectorAll('.gh-toc a');

               if (tocLinks.length === 0) {
                  // Retry after 200ms if tocbot hasn't generated links yet
                  setTimeout(attachSmoothScroll, 200);
                  return;
               }

               tocLinks.forEach(link => {
                  // Use capture phase (true) to ensure our handler runs before default anchor behavior
                  link.addEventListener('click', function (e) {
                     e.preventDefault();
                     e.stopPropagation(); // Prevent event bubbling

                     const href = this.getAttribute('href');
                     const targetId = href.startsWith('#') ? href.substring(1) : href;
                     const targetElement = document.getElementById(targetId);

                     if (targetElement) {
                        // Close the floating panel first
                        closePanel();

                        // Use native scroll with offset for better performance
                        const offsetTop = targetElement.getBoundingClientRect().top + window.pageYOffset - 100;
                        window.scrollTo({
                           top: offsetTop,
                           behavior: 'smooth'
                        });

                        // Update URL without triggering default jump
                        if (history.pushState) {
                           history.pushState(null, null, href);
                        }
                     }

                     return false; // Extra prevention for older browsers
                  }, true); // true = capture phase - runs before default behavior
               });
            };

            // Start attaching smooth scroll handlers
            attachSmoothScroll();

            // Check if tocbot actually generated any TOC items
            setTimeout(() => {
               const tocItems = document.querySelectorAll('li.toc-list-item');
               if (tocItems.length <= 0) {
                  if (floatingBtn) floatingBtn.style.display = 'none';
                  if (floatingPanel) floatingPanel.style.display = 'none';
               }
            }, 100);
         }
      });
   </script>